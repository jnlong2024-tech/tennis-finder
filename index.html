<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç½‘çƒåœºåœ°æœç´¢ | Tennis Court Finder</title>

<!-- e469d71b1acdcc134ef2e6ca1a94757d-->
<script>
window._AMapSecurityConfig = {
  securityJsCode: 'YOUR_SECURITY_CODE'
}
</script>

<!--78633132e896679bab70212f1aa966e6-->
<script src="https://webapi.amap.com/maps?v=2.0&key=YOUR_API_KEY&plugin=AMap.PlaceSearch,AMap.Geolocation,AMap.CitySearch"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#0f172a;
  color:#fff;
}
.container{
  max-width:900px;
  margin:0 auto;
  padding:20px;
}
h1{
  text-align:center;
  margin:30px 0 10px;
}
.search-box{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
input{
  flex:1;
  padding:12px;
  border-radius:8px;
  border:none;
}
button{
  padding:12px 20px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.locate{background:#2563eb;color:#fff;}
.search{background:#f59e0b;color:#000;}
.status{
  margin:10px 0;
  font-size:14px;
  opacity:0.8;
}
#map{
  width:100%;
  height:300px;
  border-radius:12px;
  margin:20px 0;
}
.card{
  background:#1e293b;
  padding:15px;
  border-radius:12px;
  margin-bottom:12px;
}
.distance{
  color:#f59e0b;
  font-weight:bold;
}
.nav-btn{
  margin-top:8px;
  display:inline-block;
  padding:6px 10px;
  background:#334155;
  border-radius:6px;
  cursor:pointer;
}
.empty{
  text-align:center;
  opacity:0.5;
  padding:40px 0;
}
</style>
</head>

<body>
<div class="container">

<h1>ğŸ¾ ç½‘çƒåœºåœ°æœç´¢</h1>

<div class="search-box">
  <input id="cityInput" placeholder="è¾“å…¥åŸå¸‚ï¼Œä¾‹å¦‚ï¼šåŒ—äº¬" />
  <button class="locate" onclick="getLocation()">ğŸ“ è‡ªåŠ¨å®šä½</button>
  <button class="search" onclick="searchCity()">æœç´¢</button>
</div>

<div id="status" class="status">
  è¯·è¾“å…¥åŸå¸‚æˆ–ç‚¹å‡»è‡ªåŠ¨å®šä½
</div>

<div id="map"></div>

<div id="result">
  <div class="empty">æš‚æ— æ•°æ®</div>
</div>

</div>

<script>
let map = null
let markers = []
let allData = []

function setStatus(msg){
  document.getElementById("status").innerText = msg
}

function initMap(center){
  if(!map){
    map = new AMap.Map('map',{
      zoom:13,
      center:center,
      mapStyle:'amap://styles/dark'
    })
  }else{
    map.setCenter(center)
  }
}

function clearMarkers(){
  markers.forEach(m=>m.setMap(null))
  markers=[]
}

function getLocation(){
  setStatus("æ­£åœ¨è·å–GPSå®šä½...")

  AMap.plugin('AMap.Geolocation',function(){
    const geo = new AMap.Geolocation({
      enableHighAccuracy:true,
      timeout:8000
    })

    geo.getCurrentPosition(function(status,result){
      if(status==="complete"){
        const lng = result.position.lng
        const lat = result.position.lat
        const city = result.addressComponent.city || result.addressComponent.province

        document.getElementById("cityInput").value = city
        setStatus("GPSå®šä½æˆåŠŸï¼š"+city)

        initMap([lng,lat])
        searchNearby([lng,lat])
      }else{
        console.warn("GPSå¤±è´¥ï¼Œå¯ç”¨IPå®šä½",result)
        ipLocate()
      }
    })
  })
}

function ipLocate(){
  setStatus("GPSå¤±è´¥ï¼Œå°è¯•IPå®šä½...")

  AMap.plugin('AMap.CitySearch',function(){
    const cs = new AMap.CitySearch()
    cs.getLocalCity(function(status,result){
      if(status==="complete" && result.city){
        document.getElementById("cityInput").value = result.city
        setStatus("IPå®šä½æˆåŠŸï¼š"+result.city)
        searchCity()
      }else{
        setStatus("å®šä½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥åŸå¸‚")
      }
    })
  })
}

function searchCity(){
  const city = document.getElementById("cityInput").value.trim()
  if(!city){
    setStatus("è¯·è¾“å…¥åŸå¸‚")
    return
  }
  setStatus("æ­£åœ¨æœç´¢ "+city+" çš„ç½‘çƒåœº...")
  doSearch({city:city})
}

function searchNearby(center){
  setStatus("æ­£åœ¨æœç´¢é™„è¿‘ç½‘çƒåœº...")
  doSearch({location:center,radius:5000})
}

function doSearch(options){
  AMap.plugin('AMap.PlaceSearch',function(){

    const ps = new AMap.PlaceSearch({
      pageSize:20,
      pageIndex:1,
      city:options.city || ""
    })

    const callback = function(status,result){
      if(status==="complete" && result.poiList && result.poiList.pois.length>0){
        const pois = result.poiList.pois
        allData = pois

        if(pois[0].location){
          initMap([pois[0].location.lng, pois[0].location.lat])
        }

        renderList(pois)
        renderMarkers(pois)
        setStatus("æ‰¾åˆ° "+pois.length+" ä¸ªåœºåœ°")
      }else{
        renderList([])
        setStatus("æœªæ‰¾åˆ°ç›¸å…³åœºåœ°")
      }
    }

    if(options.location){
      ps.searchNearBy("ç½‘çƒåœº",options.location,options.radius,callback)
    }else{
      ps.search("ç½‘çƒåœº",callback)
    }
  })
}

function renderList(data){
  const box = document.getElementById("result")
  if(!data.length){
    box.innerHTML='<div class="empty">æš‚æ— æ•°æ®</div>'
    return
  }

  box.innerHTML = data.map((p,i)=>{
    const dist = p.distance ? 
      (p.distance>1000 ? (p.distance/1000).toFixed(1)+"km" : p.distance+"m")
      : "â€”"

    const lng = p.location ? p.location.lng : null
    const lat = p.location ? p.location.lat : null

    return `
    <div class="card">
      <strong>${i+1}. ${p.name}</strong><br/>
      ${p.address || "åœ°å€æœªçŸ¥"}<br/>
      <span class="distance">${dist}</span><br/>
      ${lng ? `<div class="nav-btn" onclick="nav(${lng},${lat},'${p.name.replace(/'/g,"")}')">å¯¼èˆª</div>`:""}
    </div>
    `
  }).join("")
}

function renderMarkers(data){
  if(!map) return
  clearMarkers()

  data.forEach(p=>{
    if(!p.location) return
    const m = new AMap.Marker({
      position:[p.location.lng,p.location.lat],
      map:map
    })
    markers.push(m)
  })
  map.setFitView()
}

function nav(lng,lat,name){
  window.open(
    `https://uri.amap.com/navigation?to=${lng},${lat},${encodeURIComponent(name)}&mode=car`,
    "_blank"
  )
}

document.getElementById("cityInput").addEventListener("keydown",e=>{
  if(e.key==="Enter") searchCity()
})
</script>

</body>
</html>
