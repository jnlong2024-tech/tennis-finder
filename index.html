<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç½‘çƒåœºåœ°æœç´¢ | Tennis Court Finder</title>

<!--
  âš ï¸ ä½¿ç”¨å‰è¯·æ›¿æ¢ä»¥ä¸‹ä¸¤å¤„ï¼š
  1. YOUR_SECURITY_CODE â†’ ä½ çš„é«˜å¾·å®‰å…¨å¯†é’¥
  2. YOUR_API_KEY       â†’ ä½ çš„é«˜å¾· JS API Key
-->
<script>
window._AMapSecurityConfig = {
  securityJsCode: 'e469d71b1acdcc134ef2e6ca1a94757d'
}
</script>
<script src="https://webapi.amap.com/maps?v=2.0&key=78633132e896679bab70212f1aa966e6&plugin=AMap.PlaceSearch,AMap.Geolocation,AMap.CitySearch"></script>

<style>
  *, *::before, *::after { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", Roboto, sans-serif;
    background: #0f172a;
    color: #fff;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  h1 {
    text-align: center;
    margin: 30px 0 20px;
    font-size: 1.8rem;
    letter-spacing: 2px;
  }

  .search-box {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  input {
    flex: 1;
    min-width: 160px;
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid #334155;
    background: #1e293b;
    color: #fff;
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
  }
  input:focus { border-color: #f59e0b; }
  input::placeholder { color: #64748b; }

  button {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: opacity 0.2s, transform 0.1s;
    white-space: nowrap;
  }
  button:hover  { opacity: 0.85; }
  button:active { transform: scale(0.97); }

  .btn-locate { background: #2563eb; color: #fff; }
  .btn-search { background: #f59e0b; color: #000; }

  .status {
    margin: 12px 0 4px;
    font-size: 13px;
    color: #94a3b8;
    min-height: 18px;
  }

  #map {
    width: 100%;
    height: 320px;
    border-radius: 12px;
    margin: 16px 0;
    background: #1e293b;
    overflow: hidden;
  }

  .card {
    background: #1e293b;
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 12px;
    border: 1px solid #334155;
    line-height: 1.8;
  }
  .card strong { font-size: 15px; }
  .card .addr  { color: #94a3b8; font-size: 13px; }

  .distance {
    color: #f59e0b;
    font-weight: bold;
    font-size: 13px;
  }

  .nav-btn {
    display: inline-block;
    margin-top: 10px;
    padding: 6px 14px;
    background: #334155;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: background 0.2s;
  }
  .nav-btn:hover { background: #475569; }

  .empty {
    text-align: center;
    color: #475569;
    padding: 50px 0;
    font-size: 15px;
  }

  .results-header {
    font-size: 13px;
    color: #64748b;
    margin-bottom: 10px;
  }
</style>
</head>

<body>
<div class="container">

  <h1>ğŸ¾ ç½‘çƒåœºåœ°æœç´¢</h1>

  <div class="search-box">
    <input id="cityInput" placeholder="è¾“å…¥åŸå¸‚ï¼Œä¾‹å¦‚ï¼šåŒ—äº¬" />
    <button class="btn-locate" onclick="getLocation()">ğŸ“ è‡ªåŠ¨å®šä½</button>
    <button class="btn-search" onclick="searchCity()">æœç´¢</button>
  </div>

  <div id="status" class="status">è¯·è¾“å…¥åŸå¸‚æˆ–ç‚¹å‡»è‡ªåŠ¨å®šä½</div>

  <div id="map"></div>

  <div id="result"><div class="empty">æš‚æ— æ•°æ®</div></div>

</div>

<script>
let map = null
let markers = []

// HTML è½¬ä¹‰ï¼Œé˜² XSS
function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
}

function setStatus(msg) {
  document.getElementById('status').textContent = msg
}

function initMap(center) {
  if (!map) {
    map = new AMap.Map('map', {
      zoom: 13,
      center: center,
      mapStyle: 'amap://styles/dark'
    })
  } else {
    map.setCenter(center)
    map.setZoom(13)
  }
}

function clearMarkers() {
  markers.forEach(m => m.setMap(null))
  markers = []
}

function getLocation() {
  setStatus('æ­£åœ¨è·å– GPS å®šä½â€¦')

  AMap.plugin('AMap.Geolocation', function () {
    const geo = new AMap.Geolocation({
      enableHighAccuracy: true,
      timeout: 8000
    })

    geo.getCurrentPosition(function (status, result) {
      if (status === 'complete') {
        const lng = result.position.lng
        const lat = result.position.lat
        // ç›´è¾–å¸‚ city å­—æ®µä¸ºç©ºï¼Œé™çº§å– province
        const city = (result.addressComponent && (result.addressComponent.city || result.addressComponent.province)) || ''
        document.getElementById('cityInput').value = city
        setStatus('GPS å®šä½æˆåŠŸï¼š' + city)
        initMap([lng, lat])
        searchNearby([lng, lat])
      } else {
        console.warn('GPS å¤±è´¥ï¼Œå¯ç”¨ IP å®šä½', result)
        ipLocate()
      }
    })
  })
}

function ipLocate() {
  setStatus('GPS å¤±è´¥ï¼Œå°è¯• IP å®šä½â€¦')

  AMap.plugin('AMap.CitySearch', function () {
    const cs = new AMap.CitySearch()
    cs.getLocalCity(function (status, result) {
      if (status === 'complete' && result && result.city) {
        document.getElementById('cityInput').value = result.city
        setStatus('IP å®šä½æˆåŠŸï¼š' + result.city)
        searchCity()
      } else {
        setStatus('å®šä½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥åŸå¸‚åæœç´¢')
      }
    })
  })
}

function searchCity() {
  const city = document.getElementById('cityInput').value.trim()
  if (!city) {
    setStatus('è¯·è¾“å…¥åŸå¸‚å')
    return
  }
  setStatus('æ­£åœ¨æœç´¢ã€Œ' + city + 'ã€çš„ç½‘çƒåœºâ€¦')
  doSearch({ city: city })
}

function searchNearby(center) {
  setStatus('æ­£åœ¨æœç´¢é™„è¿‘ç½‘çƒåœºâ€¦')
  doSearch({ location: center, radius: 5000 })
}

function doSearch(options) {
  AMap.plugin('AMap.PlaceSearch', function () {
    const psOptions = { pageSize: 20, pageIndex: 1 }
    // æŒ‰åŸå¸‚æœç´¢æ—¶æ‰ä¼  cityï¼Œé¿å…é™„è¿‘æœç´¢è¢«åŸå¸‚èŒƒå›´é™åˆ¶
    if (options.city) psOptions.city = options.city

    const ps = new AMap.PlaceSearch(psOptions)

    const callback = function (status, result) {
      if (
        status === 'complete' &&
        result &&
        result.poiList &&
        result.poiList.pois &&
        result.poiList.pois.length > 0
      ) {
        const pois = result.poiList.pois
        const first = pois.find(p => p.location)
        if (first) initMap([first.location.lng, first.location.lat])
        renderList(pois)
        renderMarkers(pois)
        setStatus('å…±æ‰¾åˆ° ' + pois.length + ' ä¸ªåœºåœ°')
      } else {
        renderList([])
        setStatus('æœªæ‰¾åˆ°ç›¸å…³åœºåœ°ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯æˆ–åŸå¸‚')
      }
    }

    if (options.location) {
      // ä¿®å¤ï¼šç¬¬äºŒä¸ªå‚æ•°å¿…é¡»ä¸º AMap.LngLat å¯¹è±¡ï¼Œç›´æ¥ä¼ æ•°ç»„åœ¨éƒ¨åˆ†ç‰ˆæœ¬ä¼šå¤±è´¥
      const center = new AMap.LngLat(options.location[0], options.location[1])
      ps.searchNearBy('ç½‘çƒåœº', center, options.radius || 5000, callback)
    } else {
      ps.search('ç½‘çƒåœº', callback)
    }
  })
}

function formatDistance(raw) {
  const d = parseFloat(raw)  // ä¿®å¤ï¼šdistance å¯èƒ½ä¸ºå­—ç¬¦ä¸²ç±»å‹
  if (isNaN(d) || d <= 0) return 'â€”'
  return d >= 1000 ? (d / 1000).toFixed(1) + ' km' : Math.round(d) + ' m'
}

function renderList(data) {
  const box = document.getElementById('result')

  if (!data.length) {
    box.innerHTML = '<div class="empty">ğŸ˜• æš‚æ— æ•°æ®</div>'
    return
  }

  const header = '<div class="results-header">ä»¥ä¸‹ä¸ºæœç´¢ç»“æœï¼ˆç‚¹å‡»ã€Œå¯¼èˆªã€è·³è½¬é«˜å¾·åœ°å›¾ï¼‰</div>'

  const items = data.map((p, i) => {
    const name    = escHtml(p.name    || 'æœªçŸ¥åœºåœ°')
    const address = escHtml(p.address || 'åœ°å€æœªçŸ¥')
    const dist    = formatDistance(p.distance)
    const hasLoc  = p.location && p.location.lng && p.location.lat
    const navBtn  = hasLoc
      ? `<div class="nav-btn" onclick="nav(${p.location.lng},${p.location.lat},'${escHtml(p.name || '')}')">ğŸ—º å¯¼èˆª</div>`
      : ''

    return `
      <div class="card">
        <strong>${i + 1}. ${name}</strong><br/>
        <span class="addr">${address}</span><br/>
        ${dist !== 'â€”' ? `<span class="distance">ğŸ“ ${dist}</span><br/>` : ''}
        ${navBtn}
      </div>`
  }).join('')

  box.innerHTML = header + items
}

function renderMarkers(data) {
  if (!map) return
  clearMarkers()

  data.forEach(p => {
    if (!p.location) return
    const m = new AMap.Marker({
      position: [p.location.lng, p.location.lat],
      title: p.name || '',
      map: map
    })
    markers.push(m)
  })

  // ä¿®å¤ï¼šä¼ å…¥ markers æ•°ç»„ï¼Œè§†å›¾è‡ªé€‚åº”æ‰€æœ‰æ ‡ç‚¹
  if (markers.length > 0) map.setFitView(markers)
}

function nav(lng, lat, name) {
  window.open(
    `https://uri.amap.com/navigation?to=${lng},${lat},${encodeURIComponent(name)}&mode=car`,
    '_blank',
    'noopener,noreferrer'  // å®‰å…¨ä¿®å¤ï¼šé˜²æ­¢æ–°æ ‡ç­¾é¡µè®¿é—® window.opener
  )
}

document.getElementById('cityInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') searchCity()
})
</script>

</body>
</html>
